<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìŒì„± ì§€ì› TBM ì•ˆì „ë¯¸íŒ… ì‹œìŠ¤í…œ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nanum Gothic', 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .login-form button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-form button:hover {
            background: #5a5ecf;
        }
        
        .session-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }
        
        .session-code {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        /* ë©”ì¸ ì•± ìŠ¤íƒ€ì¼ */
        .app-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .app-header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .session-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .online-users {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tab-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            background: #f1f1f1;
            border-bottom: 2px solid #ddd;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background: white;
            border-bottom: 2px solid #667eea;
            color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }
        
        .form-section h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* ìŒì„± ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .voice-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
            align-items: center;
        }
        
        .voice-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .voice-btn.record {
            background: #ff4444;
            color: white;
        }
        
        .voice-btn.record:hover {
            background: #dd3333;
        }
        
        .voice-btn.recording {
            background: #ff6666;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .voice-btn.stop {
            background: #999;
            color: white;
        }
        
        .voice-status {
            flex: 1;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        .transcript-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .transcript-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        
        .transcript-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .transcript-speaker {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .transcript-text {
            color: #555;
        }
        
        .keyword-highlight {
            background: #ffeb3b;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .voice-memo-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .voice-memo-btn {
            background: #ff9800;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .voice-memo-btn:hover {
            background: #e68900;
        }
        
        .voice-memo-btn.recording {
            background: #ff5722;
            animation: pulse 1.5s infinite;
        }
        
        /* WorkTalk ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .worktalk-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .worktalk-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            transition: transform 0.2s;
        }
        
        .worktalk-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .worktalk-card.voice-generated {
            border: 2px solid #ff9800;
            background: #fff8e1;
        }
        
        .card-author {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .voice-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .card-photo {
            width: 100%;
            height: 150px;
            background: #e9ecef;
            border-radius: 5px;
            margin-bottom: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .risk-badge.high { background: #dc3545; }
        .risk-badge.medium { background: #ffc107; }
        .risk-badge.low { background: #28a745; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a5ecf;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }
        
        /* ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í‘œì‹œ */
        .update-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ë™ê¸°í™” ìƒíƒœ í‘œì‹œ */
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
        }
        
        .sync-status.synced {
            background: #d4edda;
            color: #155724;
        }
        
        .sync-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* ì°¸ì„ì í…Œì´ë¸” */
        .attendees-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .attendees-table th,
        .attendees-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .attendees-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .signature-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .signature-status.signed {
            background: #d4edda;
            color: #155724;
        }
        
        .signature-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        /* ë””ë²„ê·¸ ì •ë³´ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        /* ì•Œë¦¼ ë°•ìŠ¤ */
        .notice-box {
            padding: 15px;
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #0c5460;
        }
        
        .notice-box.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        /* AI ë¶„ì„ ê²°ê³¼ ë°•ìŠ¤ */
        .ai-analysis-box {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .ai-analysis-box h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .ai-analysis-item {
            margin-bottom: 8px;
            padding: 5px 10px;
            background: white;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-analysis-label {
            font-weight: bold;
            color: #1976d2;
            min-width: 80px;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .worktalk-cards {
                grid-template-columns: 1fr;
            }
            
            .app-header h1 {
                font-size: 20px;
            }
            
            .tab-button {
                font-size: 14px;
                padding: 12px;
            }
            
            .voice-controls {
                flex-wrap: wrap;
            }
        }
        
        /* ì¸ì‡„ ìŠ¤íƒ€ì¼ ê°œì„  */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            
            body {
                font-size: 11pt;
                line-height: 1.4;
            }
            
            .login-container,
            .btn,
            .btn-group,
            .tab-buttons,
            .session-status button,
            .update-indicator,
            .loading-spinner,
            .modal,
            .debug-info,
            .sync-status,
            .notice-box,
            .voice-controls,
            .transcript-box,
            .voice-memo-box {
                display: none !important;
            }
            
            .app-container {
                max-width: 100%;
                padding: 0;
            }
            
            .app-header {
                page-break-after: avoid;
                margin-bottom: 10px;
                padding: 10px;
                border: 1px solid #000;
            }
            
            .app-header h1 {
                font-size: 18pt;
                margin-bottom: 5px;
            }
            
            .session-status {
                border-top: 1px solid #ddd;
                padding-top: 5px;
                margin-top: 5px;
            }
            
            .tab-container {
                box-shadow: none;
                border: 1px solid #000;
            }
            
            /* TBM íƒ­ë§Œ ì¸ì‡„ë˜ë„ë¡ ì„¤ì • */
            #tbmTab {
                display: block !important;
                padding: 15px;
                border: none;
            }
            
            /* WorkTalk íƒ­ê³¼ ë‚´ë³´ë‚´ê¸° íƒ­ì€ ì¸ì‡„ì—ì„œ ì œì™¸ */
            #worktalkTab,
            #exportTab,
            #voiceTab {
                display: none !important;
            }
            
            .tab-content h2 {
                font-size: 14pt;
                margin-top: 0;
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 2px solid #000;
            }
            
            .form-section {
                page-break-inside: avoid;
                margin-bottom: 15px;
                padding-bottom: 10px;
            }
            
            .form-group label {
                font-weight: bold;
                font-size: 10pt;
            }
            
            input[type="text"],
            input[type="date"],
            input[type="time"],
            textarea,
            select {
                border: 1px solid #000 !important;
                background: none !important;
                padding: 3px !important;
                font-size: 10pt;
            }
            
            input[type="checkbox"] {
                width: 12px;
                height: 12px;
            }
            
            .attendees-table,
            #riskTable {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt;
                page-break-inside: auto;
            }
            
            .attendees-table th,
            .attendees-table td,
            #riskTable th,
            #riskTable td {
                border: 1px solid #000 !important;
                padding: 5px;
                page-break-inside: avoid;
            }
            
            .attendees-table tr,
            #riskTable tr {
                page-break-inside: avoid;
            }
            
            .risk-badge {
                display: inline;
                padding: 2px 4px;
                font-size: 9pt;
                background: none !important;
                border: 1px solid #000;
                color: #000 !important;
            }
            
            .risk-badge.high::before {
                content: "[ìƒ] ";
            }
            
            .risk-badge.medium::before {
                content: "[ì¤‘] ";
            }
            
            .risk-badge.low::before {
                content: "[í•˜] ";
            }
            
            .user-avatar {
                display: inline;
                border: 1px solid #000;
                padding: 2px 4px;
                margin-right: 5px;
            }
            
            .signature-status {
                border: 1px solid #000;
                padding: 2px 4px;
            }
            
            #leaderSignatureCanvas {
                border: 2px solid #000 !important;
                height: 80px !important;
            }
            
            /* TBM íƒ­ì— ì œëª© ì¶”ê°€ */
            #tbmTab::before {
                content: "TBM(Tool Box Meeting) ì‘ì—… ì „ ì•ˆì „ì ê²€íšŒì˜";
                display: block;
                font-size: 20pt;
                font-weight: bold;
                margin-bottom: 20px;
                text-align: center;
                border: 2px solid #000;
                padding: 10px;
                background: #f0f0f0;
            }
            
            /* í˜ì´ì§€ ë²ˆí˜¸ (ë¸Œë¼ìš°ì €ì—ì„œ ìë™ ì¶”ê°€) */
            @bottom-right {
                content: counter(page);
            }
        }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ì„œëª… ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
        
        .signature-canvas {
            width: 100%;
            height: 200px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: crosshair;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h2>ğŸ™ï¸ AI ìŒì„± ì§€ì› TBM ì‹œìŠ¤í…œ</h2>
            <form class="login-form" id="loginForm" onsubmit="return false;">
                <input type="text" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                <input type="text" id="sessionCode" placeholder="ì„¸ì…˜ ì½”ë“œ (ìƒˆ ì„¸ì…˜ì€ ë¹„ì›Œë‘ì„¸ìš”)">
                <button type="button" onclick="handleLogin()">ì…ì¥í•˜ê¸°</button>
            </form>
            <div class="session-info">
                <p>ğŸ”Š ìŒì„±ìœ¼ë¡œ ë” ì‰½ê²Œ!<br>ìƒˆë¡œìš´ ì„¸ì…˜ì„ ë§Œë“¤ê±°ë‚˜<br>ê¸°ì¡´ ì„¸ì…˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
        </div>
    </div>
    
    <!-- ë©”ì¸ ì•± -->
    <div class="app-container" id="mainApp">
        <div class="app-header">
            <h1>ğŸ™ï¸ AI ìŒì„± ì§€ì› TBM(Tool Box Meeting) ì•ˆì „ë¯¸íŒ…</h1>
            <div class="session-status">
                <div>
                    ì„¸ì…˜ ì½”ë“œ: <span class="session-code" id="currentSessionCode">-</span>
                    <span class="sync-status synced" id="syncStatus">
                        <span>â—</span> ë™ê¸°í™”ë¨
                    </span>
                </div>
                <div class="online-users" id="onlineUsers">
                    <span>ì°¸ì—¬ì:</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">ë‚˜ê°€ê¸°</button>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('tbm', event)">TBM ì„œì‹</button>
                <button class="tab-button" onclick="switchTab('voice', event)">ğŸ™ï¸ ìŒì„± íšŒì˜ë¡</button>
                <button class="tab-button" onclick="switchTab('worktalk', event)">WorkTalk ë°ì´í„°</button>
                <button class="tab-button" onclick="switchTab('export', event)">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
            </div>
            
            <!-- TBM ì„œì‹ íƒ­ -->
            <div class="tab-content active" id="tbmTab">
                <div class="form-section">
                    <h2>ê¸°ë³¸ ì •ë³´</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>TBM ì‹¤ì‹œì¼</label>
                            <input type="date" id="tbmDate">
                        </div>
                        <div class="form-group">
                            <label>TBM ì‹¤ì‹œì‹œê°„</label>
                            <input type="time" id="tbmTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>TBM ì‹¤ì‹œì¥ì†Œ</label>
                            <input type="text" id="tbmLocation" placeholder="ì‹¤ì‹œì¥ì†Œ ì…ë ¥">
                        </div>
                        <div class="form-group">
                            <label>ë¶€ì„œ/íŒ€</label>
                            <input type="text" id="department" placeholder="ë¶€ì„œëª… ì…ë ¥">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>TBM ë¦¬ë”</label>
                        <input type="text" id="tbmLeader" placeholder="ë¦¬ë”ëª… ì…ë ¥">
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>ì‘ì—… ë‚´ìš©</h2>
                    <div class="form-group">
                        <label>ì‘ì—…ì¥ì†Œ</label>
                        <input type="text" id="workLocation" placeholder="ì‘ì—…ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="form-group">
                        <label>ì‘ì—…ë‚´ìš©</label>
                        <textarea id="workContent" placeholder="ì‘ì—…ë‚´ìš©ì„ ìƒì„¸íˆ ê¸°ìˆ í•˜ì„¸ìš”"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ì‘ì—… ì „ ì¤€ë¹„ì‚¬í•­</label>
                        <textarea id="preparation" placeholder="ì‘ì—… ì „ ì¤€ë¹„ì‚¬í•­ì„ ê¸°ìˆ í•˜ì„¸ìš”"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ì‘ì—… ì¤‘ ì£¼ì˜ì‚¬í•­</label>
                        <textarea id="precautions" placeholder="ì‘ì—… ì¤‘ ì£¼ì˜ì‚¬í•­ì„ ê¸°ìˆ í•˜ì„¸ìš”"></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>ì°©ìš© ë³´í˜¸êµ¬</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" name="ppe" value="ì•ˆì „ëª¨" style="margin-right: 5px;"> ì•ˆì „ëª¨
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" name="ppe" value="ì•ˆì „í™”" style="margin-right: 5px;"> ì•ˆì „í™”
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" name="ppe" value="ì•ˆì „ì¥ê°‘" style="margin-right: 5px;"> ì•ˆì „ì¥ê°‘
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" name="ppe" value="ë³´ì•ˆê²½" style="margin-right: 5px;"> ë³´ì•ˆê²½
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" name="ppe" value="ë°©ì§„ë§ˆìŠ¤í¬" style="margin-right: 5px;"> ë°©ì§„ë§ˆìŠ¤í¬
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" name="ppe" value="ê·€ë§ˆê°œ" style="margin-right: 5px;"> ê·€ë§ˆê°œ
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" name="ppe" value="ì•ˆì „ëŒ€" style="margin-right: 5px;"> ì•ˆì „ëŒ€
                        </label>
                    </div>
                    <div class="form-group">
                        <input type="text" id="otherPpe" placeholder="ê¸°íƒ€ ë³´í˜¸êµ¬">
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>ìœ„í—˜ìš”ì¸ ë° ì•ˆì „ëŒ€ì±…</h2>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="forceUpdateRiskTable()">í…Œì´ë¸” ê°•ì œ ìƒˆë¡œê³ ì¹¨</button>
                        <button class="btn btn-warning" onclick="manualSync()">ìˆ˜ë™ ë™ê¸°í™”</button>
                        <button class="btn" onclick="toggleDebugInfo()">ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ</button>
                    </div>
                    <div class="debug-info" id="debugInfo"></div>
                    <div style="overflow-x: auto;">
                        <table class="attendees-table" id="riskTable">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">ìˆœë²ˆ</th>
                                    <th style="width: 15%;">ì‘ì—…ì¥ì†Œ</th>
                                    <th style="width: 20%;">ì‘ì—…ë‚´ìš©</th>
                                    <th style="width: 20%;">ìœ„í—˜ìš”ì¸</th>
                                    <th style="width: 10%;">ì‘ì—…ë¹ˆë„</th>
                                    <th style="width: 10%;">ìœ„í—˜ì¤‘ëŒ€ì„±</th>
                                    <th style="width: 10%;">ìœ„í—˜ë„</th>
                                    <th style="width: 10%;">ê°œì„ ëŒ€ì±…</th>
                                </tr>
                            </thead>
                            <tbody id="riskTableBody">
                                <!-- ìœ„í—˜ìš”ì¸ í•­ëª©ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>
                    <p style="margin-top: 10px; color: #666;">â€» WorkTalk íƒ­ì—ì„œ ìœ„í—˜ì„±í‰ê°€ë¥¼ ì‘ì„±í•˜ê±°ë‚˜ ìŒì„±ìœ¼ë¡œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤</p>
                </div>
                
                <div class="form-section">
                    <h2>ì°¸ì„ì ë° ì„œëª…</h2>
                    <table class="attendees-table">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ìƒíƒœ</th>
                                <th>ì„œëª…</th>
                            </tr>
                        </thead>
                        <tbody id="attendeesList">
                            <!-- ì°¸ì„ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="form-section">
                    <h2>TBM ë¦¬ë” ì„œëª…</h2>
                    <div style="padding: 15px; background: #f0f8ff; border-radius: 5px; margin-bottom: 15px;">
                        <p style="margin: 0; color: #0066cc;">
                            <strong>ğŸ“Œ ë¦¬ë” ì„œëª… ë°©ë²•:</strong><br>
                            1. ìœ„ì˜ "ê¸°ë³¸ ì •ë³´"ì—ì„œ TBM ë¦¬ë” ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”<br>
                            2. TBM ë¦¬ë”ë¡œ ì§€ì •ëœ ì‚¬ìš©ìë§Œ ì„œëª…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                            3. í˜„ì¬ ë¦¬ë”: <span id="currentLeaderName" style="font-weight: bold; color: #ff6600;">ë¯¸ì§€ì •</span>
                        </p>
                    </div>
                    <div style="border: 2px solid #ddd; height: 150px; border-radius: 5px; position: relative; background: white;">
                        <canvas id="leaderSignatureCanvas" style="width: 100%; height: 100%; cursor: crosshair;"></canvas>
                    </div>
                    <div class="btn-group" style="justify-content: flex-start; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="openLeaderSignatureModal()">ë¦¬ë” ì„œëª…í•˜ê¸°</button>
                        <button class="btn" onclick="clearLeaderSignature()">ì„œëª… ì§€ìš°ê¸°</button>
                    </div>
                </div>
            </div>
            
            <!-- ìŒì„± íšŒì˜ë¡ íƒ­ -->
            <div class="tab-content" id="voiceTab">
                <div class="notice-box">
                    <strong>ğŸ™ï¸ AI ìŒì„± íšŒì˜ë¡ ê¸°ëŠ¥</strong><br>
                    â€¢ TBM ë¯¸íŒ…ì„ ë…¹ìŒí•˜ë©´ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¤‘ìš” ë‚´ìš©ì„ ìë™ ì¶”ì¶œí•©ë‹ˆë‹¤<br>
                    â€¢ "ìœ„í—˜ìš”ì¸", "ì‘ì—…ë‚´ìš©", "ì£¼ì˜ì‚¬í•­" ë“± í‚¤ì›Œë“œë¥¼ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤<br>
                    â€¢ ì°¸ì„ìë³„ ë°œì–¸ì„ êµ¬ë¶„í•˜ì—¬ ê¸°ë¡í•©ë‹ˆë‹¤<br><br>
                    <strong>ğŸ“± ëª¨ë°”ì¼ ì‚¬ìš© ì‹œ:</strong><br>
                    â€¢ Chrome ë¸Œë¼ìš°ì € ê¶Œì¥ (iOSëŠ” Safari)<br>
                    â€¢ ë§ˆì´í¬ ê¶Œí•œ ë¬¸ì œ ì‹œ "ë§ˆì´í¬ í…ŒìŠ¤íŠ¸" ë²„íŠ¼ í´ë¦­<br>
                    â€¢ ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ì‹œë„í•˜ë©´ ê¶Œí•œ ì¬ìš”ì²­ ê°€ëŠ¥
                </div>
                
                <div class="voice-controls">
                    <button class="voice-btn record" id="meetingRecordBtn" onclick="toggleMeetingRecording()">
                        <span>ğŸ™ï¸</span> íšŒì˜ ë…¹ìŒ ì‹œì‘
                    </button>
                    <div class="voice-status" id="meetingStatus">ì¤€ë¹„ë¨</div>
                    <button class="btn btn-warning" onclick="testMicrophone()" style="margin-left: auto;">
                        ğŸ”§ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸
                    </button>
                </div>
                
                <div class="form-section">
                    <h2>ì‹¤ì‹œê°„ íšŒì˜ë¡</h2>
                    <div class="transcript-box" id="transcriptBox">
                        <p style="text-align: center; color: #999;">íšŒì˜ ë…¹ìŒì„ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>AI ë¶„ì„ ê²°ê³¼</h2>
                    <div class="ai-analysis-box" id="aiAnalysisBox">
                        <p style="text-align: center; color: #999;">íšŒì˜ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ë¶„ì„ë˜ì–´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
            
            <!-- WorkTalk ë°ì´í„° íƒ­ -->
            <div class="tab-content" id="worktalkTab">
                <div class="notice-box warning">
                    <strong>âš ï¸ í˜‘ì—… ì‹œ ì£¼ì˜ì‚¬í•­:</strong><br>
                    â€¢ ì—¬ëŸ¬ ëª…ì´ ë™ì‹œì— ì…ë ¥í•  ë•ŒëŠ” í•œ ë²ˆì— í•œ ëª…ì”© ìˆœì°¨ì ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”<br>
                    â€¢ ìœ„í—˜ì„±í‰ê°€ ì¶”ê°€ í›„ "ë°ì´í„°ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”<br>
                    â€¢ ë°ì´í„°ê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ "ìˆ˜ë™ ë™ê¸°í™”" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                </div>
                
                <div class="voice-memo-box">
                    <h3>ğŸ—£ï¸ ìŒì„±ìœ¼ë¡œ ìœ„í—˜ì„±í‰ê°€ ì‘ì„±í•˜ê¸°</h3>
                    <p>í˜„ì¥ì—ì„œ ìŒì„±ìœ¼ë¡œ ë§í•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ìœ„í—˜ì„±í‰ê°€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤</p>
                    <button class="voice-memo-btn" id="voiceMemoBtn" onclick="toggleVoiceMemo()">
                        <span>ğŸ¤</span> ìŒì„± ë©”ëª¨ ì‹œì‘
                    </button>
                    <div id="voiceMemoStatus" style="margin-top: 10px; font-style: italic; color: #666;"></div>
                    <div style="margin-top: 10px; font-size: 12px; color: #999;">
                        ğŸ’¡ íŒ: ê¶Œí•œ ë¬¸ì œ ì‹œ Chrome ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”
                    </div>
                </div>
                
                <h2>ìœ„í—˜ì„±í‰ê°€ ì‘ì„±</h2>
                <form id="worktalkForm">
                    <div class="form-group">
                        <label>í˜„ì¥ ì‚¬ì§„</label>
                        <input type="file" id="wtPhoto" accept="image/*">
                        <div class="card-photo" id="photoPreview">
                            <span>ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì‘ì—…ì¥ì†Œ</label>
                        <input type="text" id="wtLocation" required>
                    </div>
                    <div class="form-group">
                        <label>ì‘ì—…ë‚´ìš©</label>
                        <textarea id="wtContent" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>ìœ„í—˜ìš”ì¸</label>
                        <textarea id="wtDanger" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ì‘ì—…ë¹ˆë„</label>
                            <select id="wtFrequency" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="5">ë§¤ì¼</option>
                                <option value="4">ì£¼ 1-2íšŒ</option>
                                <option value="3">ì›” 1-2íšŒ</option>
                                <option value="2">ë¶„ê¸° 1íšŒ</option>
                                <option value="1">ë…„ 1-2íšŒ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ìœ„í—˜ì¤‘ëŒ€ì„±</label>
                            <select id="wtSeverity" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="4">ì‚¬ë§ ë˜ëŠ” ì¥ì• ì„± ì¤‘ìƒ</option>
                                <option value="3">ì¤‘ìƒ-ì…ì›í•„ìš”</option>
                                <option value="2">ê²½ìƒ-í†µì›ì¹˜ë£Œ</option>
                                <option value="1">ì•„ì°¨ì‚¬ê³ </option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ê°œì„ ëŒ€ì±…</label>
                        <textarea id="wtImprovement" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitWorktalk">ìœ„í—˜ì„±í‰ê°€ ì¶”ê°€</button>
                </form>
                
                <h2 style="margin-top: 40px;">ë“±ë¡ëœ ìœ„í—˜ì„±í‰ê°€ (ì´ <span id="worktalkCount">0</span>ê±´)</h2>
                <div class="worktalk-cards" id="worktalkCards">
                    <!-- WorkTalk ì¹´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <!-- ë°ì´í„° ë‚´ë³´ë‚´ê¸° íƒ­ -->
            <div class="tab-content" id="exportTab">
                <h2>ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h2>
                <div class="form-section">
                    <p>í˜„ì¬ ì„¸ì…˜ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ Excel íŒŒì¼ë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportToExcel()">Excelë¡œ ë‚´ë³´ë‚´ê¸°</button>
                        <button class="btn btn-primary" onclick="printDocument()">PDFë¡œ ì €ì¥/ì¸ì‡„</button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; border: 1px solid #90caf9;">
                        <h4>ğŸ’¾ ë¡œì»¬ ì„œë²„ ìë™ ì €ì¥</h4>
                        <p style="margin: 10px 0;">Excel ë‚´ë³´ë‚´ê¸° ì‹œ ë¡œì»¬ ì„œë²„ì— ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤:</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>ì„œë²„ ì£¼ì†Œ: <code>http://localhost:3000</code></li>
                            <li>ì €ì¥ ìœ„ì¹˜: <code>tbm_data/ì—°ë„ë³„í´ë”/</code></li>
                            <li>íŒŒì¼ëª…: <code>TBM_ì„¸ì…˜ì½”ë“œ_ë‚ ì§œì‹œê°„.csv</code></li>
                        </ul>
                        <p style="color: #666; font-size: 12px;">â€» ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ì§€ ì•Šì•„ë„ ë¡œì»¬ ë‹¤ìš´ë¡œë“œëŠ” ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤</p>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h4>ğŸ’¡ PDF ì €ì¥ ë°©ë²•</h4>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>ìœ„ì˜ "PDFë¡œ ì €ì¥/ì¸ì‡„" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
                            <li>ì¸ì‡„ ëŒ€í™”ìƒìì—ì„œ í”„ë¦°í„°ë¥¼ "PDFë¡œ ì €ì¥" ë˜ëŠ” "Microsoft Print to PDF"ë¡œ ì„ íƒí•˜ì„¸ìš”</li>
                            <li>ìš©ì§€ í¬ê¸°ëŠ” A4, ì—¬ë°±ì€ "ê¸°ë³¸ê°’"ì„ ê¶Œì¥í•©ë‹ˆë‹¤</li>
                            <li>"ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ PDF íŒŒì¼ë¡œ ì €ì¥í•˜ì„¸ìš”</li>
                        </ol>
                        <p style="color: #666; font-size: 14px;">â€» TBM ì„œì‹ íƒ­ì˜ ë‚´ìš©ë§Œ PDFë¡œ ì €ì¥ë©ë‹ˆë‹¤ (ìœ„í—˜ì„±í‰ê°€ ë‚´ìš©ì€ ì´ë¯¸ TBM ì„œì‹ì— í¬í•¨ë¨)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì„œëª… ëª¨ë‹¬ -->
    <div class="modal" id="signatureModal">
        <div class="modal-content">
            <h3>ì„œëª…í•˜ê¸°</h3>
            <canvas class="signature-canvas" id="signatureCanvas"></canvas>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveSignature()">ì €ì¥</button>
                <button class="btn btn-danger" onclick="clearSignature()">ì§€ìš°ê¸°</button>
                <button class="btn" onclick="closeSignatureModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
    </div>
    
    <!-- ì—…ë°ì´íŠ¸ í‘œì‹œ -->
    <div class="update-indicator" id="updateIndicator">
        <span id="updateMessage">ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤</span>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let sessionData = {
            sessionCode: '',
            users: [],
            tbmData: {},
            worktalkData: [],
            signatures: {},
            voiceTranscripts: [], // ìŒì„± íšŒì˜ë¡
            version: 0
        };
        
        // ìŒì„± ì¸ì‹ ê´€ë ¨ ë³€ìˆ˜
        let recognition = null;
        let isMeetingRecording = false;
        let isVoiceMemoRecording = false;
        let meetingStartTime = null;
        let currentSpeaker = null;
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEY = 'tbm_sessions';
        
        // ë””ë²„ê·¸ ëª¨ë“œ
        let debugMode = false;
        
        // ë™ê¸°í™” ìƒíƒœ
        let isSyncing = false;
        let syncInterval = null;
        
        // ì•ˆì „ ê´€ë ¨ í‚¤ì›Œë“œ
        const SAFETY_KEYWORDS = {
            danger: ['ìœ„í—˜', 'ì¶”ë½', 'ì¶©ëŒ', 'í˜‘ì°©', 'ê°ì „', 'í™”ì¬', 'í­ë°œ', 'ì§ˆì‹', 'ë¶•ê´´', 'ë‚™í•˜ë¬¼', 'ì „ë„', 'ë² ì„', 'ì°”ë¦¼'],
            work: ['ì‘ì—…', 'ê³µì‚¬', 'ì„¤ì¹˜', 'í•´ì²´', 'ìš©ì ‘', 'ì ˆë‹¨', 'ë„ì¥', 'ìš´ë°˜', 'ì ì¬', 'êµ´ì°©', 'ë°°ê´€', 'ì „ê¸°'],
            ppe: ['ì•ˆì „ëª¨', 'ì•ˆì „í™”', 'ì•ˆì „ëŒ€', 'ì•ˆì „ì¥ê°‘', 'ë³´ì•ˆê²½', 'ë°©ì§„ë§ˆìŠ¤í¬', 'ê·€ë§ˆê°œ', 'ë³´í˜¸êµ¬'],
            action: ['ì£¼ì˜', 'í™•ì¸', 'ì ê²€', 'ì°©ìš©', 'ì„¤ì¹˜', 'ì°¨ë‹¨', 'ê²©ë¦¬', 'í‘œì‹œ', 'êµìœ¡', 'ì¤€ìˆ˜']
        };
        
        // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
        function initializeSpeechRecognition() {
            console.log('ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì‹œì‘...');
            
            // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                const msg = 'âŒ ìŒì„± ì¸ì‹ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €\n\n' +
                           'ì§€ì› ë¸Œë¼ìš°ì €:\n' +
                           'â€¢ PC: Chrome, Edge\n' +
                           'â€¢ Android: Chrome\n' +
                           'â€¢ iOS: Safari (Chrome X)\n\n' +
                           'í˜„ì¬ ë¸Œë¼ìš°ì €ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!';
                alert(msg);
                console.error('ìŒì„± ì¸ì‹ API ë¯¸ì§€ì›');
                return false;
            }
            
            console.log('âœ… ìŒì„± ì¸ì‹ API ì§€ì› í™•ì¸');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;  // ê³„ì† ë“£ê¸°
            recognition.interimResults = true;  // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
            recognition.lang = 'ko-KR';  // í•œêµ­ì–´
            recognition.maxAlternatives = 1;  // ëŒ€ì•ˆ ê²°ê³¼ 1ê°œ
            
            recognition.onstart = function() {
                console.log('âœ… ìŒì„± ì¸ì‹ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
                showUpdateIndicator('ìŒì„± ì¸ì‹ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
            };
            
            recognition.onresult = handleSpeechResult;
            recognition.onerror = handleSpeechError;
            recognition.onend = handleSpeechEnd;
            
            console.log('âœ… ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì™„ë£Œ');
            return true;
        }
        
        // ìŒì„± ì¸ì‹ ê²°ê³¼ ì²˜ë¦¬
        function handleSpeechResult(event) {
            console.log('ìŒì„± ì¸ì‹ ì´ë²¤íŠ¸ ë°œìƒ:', event);
            
            if (!event.results || event.results.length === 0) {
                console.log('ìŒì„± ì¸ì‹ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const current = event.resultIndex;
            const transcript = event.results[current][0].transcript;
            
            console.log('ì¸ì‹ëœ í…ìŠ¤íŠ¸:', transcript, 'Final:', event.results[current].isFinal);
            
            if (event.results[current].isFinal) {
                console.log('ìµœì¢… ì¸ì‹ ê²°ê³¼:', transcript);
                if (isMeetingRecording) {
                    processMeetingTranscript(transcript);
                } else if (isVoiceMemoRecording) {
                    processVoiceMemo(transcript);
                }
            } else {
                // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
                if (isMeetingRecording) {
                    updateMeetingStatus(`ë“£ëŠ” ì¤‘: ${transcript}`);
                    // ì¤‘ê°„ ê²°ê³¼ë„ í™”ë©´ì— í‘œì‹œ
                    showInterimTranscript(transcript);
                } else if (isVoiceMemoRecording) {
                    updateVoiceMemoStatus(`ë“£ëŠ” ì¤‘: ${transcript}`);
                }
            }
        }
        
        // ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showInterimTranscript(text) {
            const transcriptBox = document.getElementById('transcriptBox');
            
            // ì´ˆê¸° ë©”ì‹œì§€ ì œê±°
            if (transcriptBox.querySelector('p')) {
                transcriptBox.innerHTML = '';
            }
            
            // ì„ì‹œ í…ìŠ¤íŠ¸ í‘œì‹œ ë˜ëŠ” ì—…ë°ì´íŠ¸
            let interimDiv = document.getElementById('interimTranscript');
            if (!interimDiv) {
                interimDiv = document.createElement('div');
                interimDiv.id = 'interimTranscript';
                interimDiv.style.opacity = '0.6';
                interimDiv.style.fontStyle = 'italic';
                interimDiv.className = 'transcript-item';
                transcriptBox.appendChild(interimDiv);
            }
            
            interimDiv.innerHTML = `
                <div class="transcript-time">${new Date().toLocaleTimeString('ko-KR')}</div>
                <div class="transcript-speaker">${currentUser.name} (ì¸ì‹ ì¤‘...)</div>
                <div class="transcript-text">${text}</div>
            `;
        }
        
        // íšŒì˜ë¡ ì²˜ë¦¬
        function processMeetingTranscript(transcript) {
            console.log('íšŒì˜ë¡ ì²˜ë¦¬ ì‹œì‘:', transcript);
            
            // ì„ì‹œ í…ìŠ¤íŠ¸ ì œê±°
            const interimDiv = document.getElementById('interimTranscript');
            if (interimDiv) {
                interimDiv.remove();
            }
            
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            
            // íšŒì˜ë¡ì— ì¶”ê°€
            const transcriptItem = {
                time: timestamp,
                speaker: currentSpeaker || currentUser.name,
                text: transcript,
                keywords: extractKeywords(transcript)
            };
            
            if (!sessionData.voiceTranscripts) {
                sessionData.voiceTranscripts = [];
            }
            sessionData.voiceTranscripts.push(transcriptItem);
            
            // UI ì—…ë°ì´íŠ¸
            addTranscriptToUI(transcriptItem);
            
            // AI ë¶„ì„
            analyzeTranscript(transcript);
            
            // ì„¸ì…˜ ì €ì¥
            saveSession();
            
            // ì„±ê³µ í”¼ë“œë°±
            showUpdateIndicator('ìŒì„±ì´ ì¸ì‹ë˜ì–´ íšŒì˜ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        // ìŒì„± ë©”ëª¨ ì²˜ë¦¬
        function processVoiceMemo(transcript) {
            console.log('ìŒì„± ë©”ëª¨ ì¸ì‹:', transcript);
            
            // AI ë¶„ì„ìœ¼ë¡œ ìœ„í—˜ì„±í‰ê°€ ìë™ ìƒì„±
            const analysis = analyzeRiskFromVoice(transcript);
            
            if (analysis) {
                // í¼ì— ìë™ ì…ë ¥
                document.getElementById('wtLocation').value = analysis.location || '';
                document.getElementById('wtContent').value = analysis.work || '';
                document.getElementById('wtDanger').value = analysis.danger || '';
                document.getElementById('wtImprovement').value = analysis.improvement || '';
                
                // ìœ„í—˜ë„ ìë™ ì„¤ì •
                if (analysis.frequency) {
                    document.getElementById('wtFrequency').value = analysis.frequency;
                }
                if (analysis.severity) {
                    document.getElementById('wtSeverity').value = analysis.severity;
                }
                
                showUpdateIndicator('ìŒì„± ë©”ëª¨ê°€ ìœ„í—˜ì„±í‰ê°€ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤');
            }
            
            updateVoiceMemoStatus(`ì¸ì‹ ì™„ë£Œ: "${transcript}"`);
        }
        
        // ìŒì„±ì—ì„œ ìœ„í—˜ì„±í‰ê°€ ë¶„ì„
        function analyzeRiskFromVoice(text) {
            const analysis = {
                location: '',
                work: '',
                danger: '',
                improvement: '',
                frequency: null,
                severity: null
            };
            
            // ì¥ì†Œ ì¶”ì¶œ
            const locationMatch = text.match(/(\d+ì¸µ|ì§€í•˜|ì˜¥ìƒ|[ê°€-í£]+ì‹¤|[ê°€-í£]+ì¥|[ê°€-í£]+ì†Œ)/);
            if (locationMatch) {
                analysis.location = locationMatch[0];
            }
            
            // ì‘ì—… ë‚´ìš© ì¶”ì¶œ
            const workKeywords = SAFETY_KEYWORDS.work;
            for (const keyword of workKeywords) {
                if (text.includes(keyword)) {
                    const workMatch = text.match(new RegExp(`([ê°€-í£\\s]+${keyword}[ê°€-í£\\s]*)`));
                    if (workMatch) {
                        analysis.work = workMatch[0].trim();
                        break;
                    }
                }
            }
            
            // ìœ„í—˜ ìš”ì¸ ì¶”ì¶œ
            const dangerKeywords = SAFETY_KEYWORDS.danger;
            for (const keyword of dangerKeywords) {
                if (text.includes(keyword)) {
                    analysis.danger = keyword + ' ìœ„í—˜';
                    
                    // ìœ„í—˜ ì¤‘ëŒ€ì„± ìë™ ì„¤ì •
                    if (['ì¶”ë½', 'ê°ì „', 'í­ë°œ', 'ë¶•ê´´'].includes(keyword)) {
                        analysis.severity = 4; // ì‚¬ë§ ê°€ëŠ¥
                    } else if (['ì¶©ëŒ', 'í˜‘ì°©', 'í™”ì¬'].includes(keyword)) {
                        analysis.severity = 3; // ì¤‘ìƒ
                    } else {
                        analysis.severity = 2; // ê²½ìƒ
                    }
                    break;
                }
            }
            
            // ê°œì„  ëŒ€ì±… ì¶”ì¶œ
            const ppeKeywords = SAFETY_KEYWORDS.ppe;
            const improvements = [];
            for (const keyword of ppeKeywords) {
                if (text.includes(keyword)) {
                    improvements.push(keyword + ' ì°©ìš©');
                }
            }
            
            const actionKeywords = SAFETY_KEYWORDS.action;
            for (const keyword of actionKeywords) {
                if (text.includes(keyword)) {
                    const actionMatch = text.match(new RegExp(`([ê°€-í£\\s]*${keyword}[ê°€-í£\\s]*)`));
                    if (actionMatch) {
                        improvements.push(actionMatch[0].trim());
                    }
                }
            }
            
            if (improvements.length > 0) {
                analysis.improvement = improvements.join(', ');
            }
            
            // ì‘ì—… ë¹ˆë„ ì¶”ì¸¡ (ê¸°ë³¸ê°’)
            analysis.frequency = 3; // ì›” 1-2íšŒ ê¸°ë³¸ê°’
            
            return analysis;
        }
        
        // í‚¤ì›Œë“œ ì¶”ì¶œ
        function extractKeywords(text) {
            const keywords = [];
            
            for (const category in SAFETY_KEYWORDS) {
                for (const keyword of SAFETY_KEYWORDS[category]) {
                    if (text.includes(keyword)) {
                        keywords.push(keyword);
                    }
                }
            }
            
            return keywords;
        }
        
        // íšŒì˜ë¡ UI ì¶”ê°€
        function addTranscriptToUI(item) {
            const transcriptBox = document.getElementById('transcriptBox');
            
            // ì´ˆê¸° ë©”ì‹œì§€ ì œê±°
            if (transcriptBox.querySelector('p')) {
                transcriptBox.innerHTML = '';
            }
            
            const transcriptDiv = document.createElement('div');
            transcriptDiv.className = 'transcript-item';
            
            let highlightedText = item.text;
            item.keywords.forEach(keyword => {
                highlightedText = highlightedText.replace(
                    new RegExp(keyword, 'g'),
                    `<span class="keyword-highlight">${keyword}</span>`
                );
            });
            
            transcriptDiv.innerHTML = `
                <div class="transcript-time">${item.time}</div>
                <div class="transcript-speaker">${item.speaker}</div>
                <div class="transcript-text">${highlightedText}</div>
            `;
            
            transcriptBox.appendChild(transcriptDiv);
            transcriptBox.scrollTop = transcriptBox.scrollHeight;
        }
        
        // AI ë¶„ì„
        function analyzeTranscript(text) {
            const aiBox = document.getElementById('aiAnalysisBox');
            
            // ì´ˆê¸° ë©”ì‹œì§€ ì œê±°
            if (aiBox.querySelector('p')) {
                aiBox.innerHTML = '<h4>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h4>';
            }
            
            const analysis = {
                dangers: [],
                works: [],
                ppes: [],
                actions: []
            };
            
            // ìœ„í—˜ ìš”ì¸ ë¶„ì„
            SAFETY_KEYWORDS.danger.forEach(keyword => {
                if (text.includes(keyword)) {
                    analysis.dangers.push(keyword);
                }
            });
            
            // ì‘ì—… ë‚´ìš© ë¶„ì„
            SAFETY_KEYWORDS.work.forEach(keyword => {
                if (text.includes(keyword)) {
                    analysis.works.push(keyword);
                }
            });
            
            // ë³´í˜¸êµ¬ ë¶„ì„
            SAFETY_KEYWORDS.ppe.forEach(keyword => {
                if (text.includes(keyword)) {
                    analysis.ppes.push(keyword);
                }
            });
            
            // ì¡°ì¹˜ì‚¬í•­ ë¶„ì„
            SAFETY_KEYWORDS.action.forEach(keyword => {
                if (text.includes(keyword)) {
                    analysis.actions.push(keyword);
                }
            });
            
            // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            if (analysis.dangers.length > 0) {
                addAnalysisItem(aiBox, 'ìœ„í—˜ìš”ì¸', analysis.dangers.join(', '));
            }
            if (analysis.works.length > 0) {
                addAnalysisItem(aiBox, 'ì‘ì—…ë‚´ìš©', analysis.works.join(', '));
            }
            if (analysis.ppes.length > 0) {
                addAnalysisItem(aiBox, 'í•„ìš”ë³´í˜¸êµ¬', analysis.ppes.join(', '));
            }
            if (analysis.actions.length > 0) {
                addAnalysisItem(aiBox, 'ì¡°ì¹˜ì‚¬í•­', analysis.actions.join(', '));
            }
        }
        
        // ë¶„ì„ í•­ëª© ì¶”ê°€
        function addAnalysisItem(container, label, value) {
            const item = document.createElement('div');
            item.className = 'ai-analysis-item';
            item.innerHTML = `
                <span class="ai-analysis-label">${label}:</span>
                <span>${value}</span>
            `;
            container.appendChild(item);
        }
        
        // íšŒì˜ ë…¹ìŒ í† ê¸€
        async function toggleMeetingRecording() {
            if (!recognition && !initializeSpeechRecognition()) {
                return;
            }
            
            const btn = document.getElementById('meetingRecordBtn');
            
            if (!isMeetingRecording) {
                try {
                    // ë¨¼ì € ê¶Œí•œ ìƒíƒœ í™•ì¸
                    if (navigator.permissions && navigator.permissions.query) {
                        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                        console.log('ë§ˆì´í¬ ê¶Œí•œ ìƒíƒœ:', permissionStatus.state);
                        
                        if (permissionStatus.state === 'denied') {
                            alert('ë§ˆì´í¬ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\nğŸ“± í•´ê²° ë°©ë²•:\n1. í•¸ë“œí° ì„¤ì • ì•± ì—´ê¸°\n2. ì•± â†’ Chrome â†’ ê¶Œí•œ\n3. ë§ˆì´í¬ ì¼œê¸°\n\në˜ëŠ” ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!');
                            return;
                        }
                    }
                    
                    // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ (ì´ ë¶€ë¶„ì—ì„œ íŒì—…ì´ ë‚˜íƒ€ë‚˜ì•¼ í•¨)
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬ (ê¶Œí•œë§Œ í™•ì¸í•˜ê³  ì‹¤ì œ ë…¹ìŒì€ ìŒì„±ì¸ì‹ APIê°€ ì²˜ë¦¬)
                    stream.getTracks().forEach(track => track.stop());
                    
                    // ë…¹ìŒ ì‹œì‘
                    isMeetingRecording = true;
                    meetingStartTime = new Date();
                    btn.classList.add('recording');
                    btn.innerHTML = '<span>â¹ï¸</span> ë…¹ìŒ ì¤‘ì§€';
                    updateMeetingStatus('ğŸ¤ ë…¹ìŒ ì¤‘... (ë§ì”€í•´ì£¼ì„¸ìš”)');
                    
                    // ìŒì„± ì¸ì‹ ì‹œì‘
                    recognition.start();
                    console.log('ìŒì„± ì¸ì‹ ì‹œì‘ë¨');
                    
                    // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
                    showUpdateIndicator('ë§ˆì´í¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ì”€í•´ì£¼ì„¸ìš”.');
                } catch (error) {
                    console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                    
                    // ë” ì¹œì ˆí•œ ì˜¤ë¥˜ ë©”ì‹œì§€
                    let errorMsg = 'ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:\n\n';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMsg += 'ğŸ“± ê¶Œí•œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
                        errorMsg += 'í•´ê²° ë°©ë²•:\n';
                        errorMsg += '1. Chrome ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ë‹¤ì‹œ ì‹œë„\n';
                        errorMsg += '2. ë˜ëŠ” í•¸ë“œí° ì„¤ì • â†’ ì•± â†’ Chrome â†’ ê¶Œí•œ â†’ ë§ˆì´í¬ ON';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg += 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n';
                        errorMsg += 'ì´ì–´í°ì„ ì—°ê²°í•˜ê±°ë‚˜ ë§ˆì´í¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
                    } else {
                        errorMsg += error.message;
                    }
                    
                    alert(errorMsg);
                    updateMeetingStatus('ë§ˆì´í¬ ì‚¬ìš© ë¶ˆê°€');
                }
            } else {
                // ë…¹ìŒ ì¤‘ì§€
                isMeetingRecording = false;
                btn.classList.remove('recording');
                btn.innerHTML = '<span>ğŸ™ï¸</span> íšŒì˜ ë…¹ìŒ ì‹œì‘';
                updateMeetingStatus('ë…¹ìŒ ì™„ë£Œ');
                
                recognition.stop();
                console.log('ìŒì„± ì¸ì‹ ì¤‘ì§€ë¨');
                
                // ì„ì‹œ í…ìŠ¤íŠ¸ ì œê±°
                const interimDiv = document.getElementById('interimTranscript');
                if (interimDiv) {
                    interimDiv.remove();
                }
            }
        }
        
        // ìŒì„± ë©”ëª¨ í† ê¸€
        async function toggleVoiceMemo() {
            if (!recognition && !initializeSpeechRecognition()) {
                return;
            }
            
            const btn = document.getElementById('voiceMemoBtn');
            
            if (!isVoiceMemoRecording) {
                try {
                    // ë¨¼ì € ê¶Œí•œ ìƒíƒœ í™•ì¸
                    if (navigator.permissions && navigator.permissions.query) {
                        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                        console.log('ë§ˆì´í¬ ê¶Œí•œ ìƒíƒœ:', permissionStatus.state);
                        
                        if (permissionStatus.state === 'denied') {
                            alert('ë§ˆì´í¬ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\nğŸ“± í•´ê²° ë°©ë²•:\n1. í•¸ë“œí° ì„¤ì • ì•± ì—´ê¸°\n2. ì•± â†’ Chrome â†’ ê¶Œí•œ\n3. ë§ˆì´í¬ ì¼œê¸°\n\në˜ëŠ” ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!');
                            return;
                        }
                    }
                    
                    // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                    stream.getTracks().forEach(track => track.stop());
                    
                    // ë…¹ìŒ ì‹œì‘
                    isVoiceMemoRecording = true;
                    btn.classList.add('recording');
                    btn.innerHTML = '<span>â¹ï¸</span> ë…¹ìŒ ì¤‘ì§€';
                    updateVoiceMemoStatus('ë§ì”€í•´ì£¼ì„¸ìš”...');
                    
                    recognition.start();
                    console.log('ìŒì„± ë©”ëª¨ ì‹œì‘ë¨');
                    
                    showUpdateIndicator('ìŒì„± ë©”ëª¨ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„í—˜ ìƒí™©ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”.');
                } catch (error) {
                    console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                    
                    let errorMsg = 'ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:\n\n';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMsg += 'ğŸ“± ê¶Œí•œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
                        errorMsg += 'í•´ê²° ë°©ë²•:\n';
                        errorMsg += '1. Chrome ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ë‹¤ì‹œ ì‹œë„\n';
                        errorMsg += '2. ë˜ëŠ” í•¸ë“œí° ì„¤ì • â†’ ì•± â†’ Chrome â†’ ê¶Œí•œ â†’ ë§ˆì´í¬ ON';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg += 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n';
                        errorMsg += 'ì´ì–´í°ì„ ì—°ê²°í•˜ê±°ë‚˜ ë§ˆì´í¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
                    } else {
                        errorMsg += error.message;
                    }
                    
                    alert(errorMsg);
                    updateVoiceMemoStatus('ë§ˆì´í¬ ì‚¬ìš© ë¶ˆê°€');
                }
            } else {
                // ë…¹ìŒ ì¤‘ì§€
                isVoiceMemoRecording = false;
                btn.classList.remove('recording');
                btn.innerHTML = '<span>ğŸ¤</span> ìŒì„± ë©”ëª¨ ì‹œì‘';
                updateVoiceMemoStatus('ë…¹ìŒ ì™„ë£Œ');
                
                recognition.stop();
                console.log('ìŒì„± ë©”ëª¨ ì¤‘ì§€ë¨');
            }
        }
        
        // ìŒì„± ì¸ì‹ ì˜¤ë¥˜ ì²˜ë¦¬
        function handleSpeechError(event) {
            console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
            
            let errorMessage = 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ';
            switch(event.error) {
                case 'no-speech':
                    errorMessage += 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§ˆì´í¬ ê°€ê¹Œì´ì—ì„œ ë§ì”€í•´ì£¼ì„¸ìš”.';
                    // ìë™ ì¬ì‹œì‘
                    if (isMeetingRecording || isVoiceMemoRecording) {
                        setTimeout(() => {
                            recognition.start();
                            console.log('ìŒì„± ì¸ì‹ ì¬ì‹œì‘');
                        }, 1000);
                    }
                    break;
                case 'audio-capture':
                    errorMessage += 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´í¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    break;
                case 'not-allowed':
                    errorMessage += 'ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                    // ë…¹ìŒ ì¤‘ì§€
                    if (isMeetingRecording) {
                        toggleMeetingRecording();
                    }
                    if (isVoiceMemoRecording) {
                        toggleVoiceMemo();
                    }
                    break;
                case 'aborted':
                    errorMessage += 'ë‹¤ë¥¸ ì•±ì´ ë§ˆì´í¬ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.';
                    break;
                case 'network':
                    errorMessage += 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    break;
                default:
                    errorMessage += event.error;
            }
            
            if (isMeetingRecording) {
                updateMeetingStatus(errorMessage);
            } else if (isVoiceMemoRecording) {
                updateVoiceMemoStatus(errorMessage);
            }
            
            showUpdateIndicator(errorMessage);
        }
        
        // ìŒì„± ì¸ì‹ ì¢…ë£Œ ì²˜ë¦¬
        function handleSpeechEnd() {
            console.log('ìŒì„± ì¸ì‹ ì¢…ë£Œ ì´ë²¤íŠ¸ ë°œìƒ');
            
            if (isMeetingRecording || isVoiceMemoRecording) {
                // ê³„ì† ë…¹ìŒ ì¤‘ì´ë©´ ì¬ì‹œì‘
                console.log('ë…¹ìŒ ì¤‘ì´ë¯€ë¡œ ìŒì„± ì¸ì‹ ì¬ì‹œì‘...');
                setTimeout(() => {
                    try {
                        recognition.start();
                        console.log('ìŒì„± ì¸ì‹ ì¬ì‹œì‘ë¨');
                    } catch (e) {
                        console.error('ìŒì„± ì¸ì‹ ì¬ì‹œì‘ ì‹¤íŒ¨:', e);
                    }
                }, 500);
            }
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
        function updateMeetingStatus(message) {
            const statusEl = document.getElementById('meetingStatus');
            statusEl.textContent = message;
            
            // ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
            if (message.includes('ë…¹ìŒ ì¤‘')) {
                statusEl.style.color = '#28a745';
                statusEl.style.fontWeight = 'bold';
            } else if (message.includes('ì˜¤ë¥˜') || message.includes('ì°¨ë‹¨')) {
                statusEl.style.color = '#dc3545';
            } else {
                statusEl.style.color = '#333';
                statusEl.style.fontWeight = 'normal';
            }
        }
        
        function updateVoiceMemoStatus(message) {
            const statusEl = document.getElementById('voiceMemoStatus');
            statusEl.textContent = message;
            
            // ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
            if (message.includes('ë“£ëŠ” ì¤‘')) {
                statusEl.style.color = '#28a745';
            } else if (message.includes('ì˜¤ë¥˜') || message.includes('ì°¨ë‹¨')) {
                statusEl.style.color = '#dc3545';
            } else {
                statusEl.style.color = '#666';
            }
        }
        
        // ì„¸ì…˜ ì½”ë“œ ìƒì„±
        function generateSessionCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        // ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ê°œì„ ëœ ë²„ì „)
        function saveSession() {
            try {
                isSyncing = true;
                updateSyncStatus('syncing');
                
                // ë²„ì „ ì¦ê°€
                sessionData.version = (sessionData.version || 0) + 1;
                sessionData.lastUpdated = new Date().toISOString();
                sessionData.lastUpdatedBy = currentUser ? currentUser.name : 'Unknown';
                
                const sessions = getSavedSessions();
                sessions[sessionData.sessionCode] = sessionData;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
                
                if (debugMode) {
                    console.log('ì„¸ì…˜ ì €ì¥ë¨:', {
                        version: sessionData.version,
                        worktalkCount: sessionData.worktalkData.length,
                        voiceTranscriptsCount: sessionData.voiceTranscripts ? sessionData.voiceTranscripts.length : 0,
                        lastUpdatedBy: sessionData.lastUpdatedBy
                    });
                }
                
                setTimeout(() => {
                    isSyncing = false;
                    updateSyncStatus('synced');
                }, 500);
                
                return true;
            } catch (error) {
                console.error('ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
                updateSyncStatus('error');
                return false;
            }
        }
        
        // ì €ì¥ëœ ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸°
        function getSavedSessions() {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : {};
        }
        
        // ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSyncStatus(status) {
            const statusElement = document.getElementById('syncStatus');
            if (!statusElement) return;
            
            statusElement.className = `sync-status ${status}`;
            
            switch(status) {
                case 'syncing':
                    statusElement.innerHTML = '<span>âŸ³</span> ë™ê¸°í™” ì¤‘...';
                    break;
                case 'synced':
                    statusElement.innerHTML = '<span>â—</span> ë™ê¸°í™”ë¨';
                    break;
                case 'error':
                    statusElement.innerHTML = '<span>âš </span> ë™ê¸°í™” ì˜¤ë¥˜';
                    break;
            }
        }
        
        // ìˆ˜ë™ ë™ê¸°í™”
        function manualSync() {
            console.log('ìˆ˜ë™ ë™ê¸°í™” ì‹œì‘');
            
            const sessions = getSavedSessions();
            if (sessions[sessionData.sessionCode]) {
                const serverData = sessions[sessionData.sessionCode];
                
                // ë²„ì „ ë¹„êµë¡œ ìµœì‹  ë°ì´í„° í™•ì¸
                if (serverData.version > sessionData.version) {
                    console.log('ì„œë²„ì— ìƒˆë¡œìš´ ë°ì´í„° ë°œê²¬');
                    sessionData = serverData;
                    updateUI();
                    showUpdateIndicator('ë°ì´í„°ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                } else {
                    showUpdateIndicator('ì´ë¯¸ ìµœì‹  ë°ì´í„°ì…ë‹ˆë‹¤');
                }
            }
            
            // ìœ„í—˜ìš”ì¸ í…Œì´ë¸” ê°•ì œ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updateRiskTable();
            }, 100);
        }
        
        // ê°•ì œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function forceUpdateRiskTable() {
            console.log('í…Œì´ë¸” ê°•ì œ ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            // ë¨¼ì € ìµœì‹  ë°ì´í„° ë™ê¸°í™”
            manualSync();
            
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updateRiskTable();
                updateWorktalkCards();
                updateWorktalkCount();
                showUpdateIndicator('í…Œì´ë¸”ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
            }, 200);
        }
        
        // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLogin() {
            console.log('ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­');
            
            const userName = document.getElementById('userName').value.trim();
            let sessionCode = document.getElementById('sessionCode').value.trim();
            
            if (!userName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìƒˆ ì„¸ì…˜ ìƒì„± ë˜ëŠ” ê¸°ì¡´ ì„¸ì…˜ ì°¸ì—¬
            if (!sessionCode) {
                sessionCode = generateSessionCode();
                sessionData.sessionCode = sessionCode;
                sessionData.users = [];
                sessionData.tbmData = {
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toTimeString().split(' ')[0].substring(0, 5)
                };
                sessionData.worktalkData = [];
                sessionData.signatures = {};
                sessionData.voiceTranscripts = [];
                sessionData.version = 0;
                console.log('ìƒˆ ì„¸ì…˜ ìƒì„±:', sessionCode);
            } else {
                // ê¸°ì¡´ ì„¸ì…˜ ë¡œë“œ
                const savedSessions = getSavedSessions();
                if (savedSessions[sessionCode]) {
                    sessionData = savedSessions[sessionCode];
                    console.log('ê¸°ì¡´ ì„¸ì…˜ ë¡œë“œ:', sessionCode, 'ë²„ì „:', sessionData.version);
                } else {
                    alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì„¸ì…˜ ì½”ë“œì…ë‹ˆë‹¤.');
                    return;
                }
            }
            
            // ì‚¬ìš©ì ì¶”ê°€
            currentUser = {
                name: userName,
                id: Date.now().toString(),
                joinedAt: new Date().toISOString()
            };
            
            // ì¤‘ë³µ ì‚¬ìš©ì í™•ì¸
            const existingUser = sessionData.users.find(u => u.name === userName);
            if (existingUser) {
                currentUser = existingUser;
            } else {
                sessionData.users.push(currentUser);
            }
            
            // ì„¸ì…˜ ì €ì¥
            saveSession();
            
            // í™”ë©´ ì „í™˜
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            console.log('ë¡œê·¸ì¸ ì„±ê³µ:', currentUser);
            
            // UI ì—…ë°ì´íŠ¸
            updateUI();
            startAutoSync();
            initializeEventListeners();
            
            // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
            console.log('ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì‹œë„...');
            if (initializeSpeechRecognition()) {
                console.log('âœ… ìŒì„± ì¸ì‹ ì¤€ë¹„ ì™„ë£Œ');
            } else {
                console.log('âŒ ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì‹¤íŒ¨');
            }
            
            // ì´ˆê¸° ìœ„í—˜ìš”ì¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updateRiskTable();
                updateWorktalkCount();
            }, 500);
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            // ì„¸ì…˜ ì½”ë“œ í‘œì‹œ
            document.getElementById('currentSessionCode').textContent = sessionData.sessionCode;
            
            // ì˜¨ë¼ì¸ ì‚¬ìš©ì í‘œì‹œ
            const onlineUsersDiv = document.getElementById('onlineUsers');
            onlineUsersDiv.innerHTML = '<span>ì°¸ì—¬ì:</span>';
            sessionData.users.forEach(user => {
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.textContent = user.name.substring(0, 2);
                avatar.title = user.name;
                onlineUsersDiv.appendChild(avatar);
            });
            
            // ì°¸ì„ì ëª©ë¡ ì—…ë°ì´íŠ¸
            updateAttendeesList();
            
            // WorkTalk ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateWorktalkCards();
            
            // ìœ„í—˜ìš”ì¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateRiskTable();
            
            // WorkTalk ê°œìˆ˜ ì—…ë°ì´íŠ¸
            updateWorktalkCount();
            
            // TBM ë°ì´í„° ë¡œë“œ
            if (sessionData.tbmData) {
                document.getElementById('tbmDate').value = sessionData.tbmData.date || '';
                document.getElementById('tbmTime').value = sessionData.tbmData.time || '';
                document.getElementById('tbmLocation').value = sessionData.tbmData.location || '';
                document.getElementById('department').value = sessionData.tbmData.department || '';
                document.getElementById('tbmLeader').value = sessionData.tbmData.leader || '';
                document.getElementById('workLocation').value = sessionData.tbmData.workLocation || '';
                document.getElementById('workContent').value = sessionData.tbmData.workContent || '';
                document.getElementById('preparation').value = sessionData.tbmData.preparation || '';
                document.getElementById('precautions').value = sessionData.tbmData.precautions || '';
                
                // ë³´í˜¸êµ¬ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
                if (sessionData.tbmData.ppe) {
                    document.querySelectorAll('input[name="ppe"]').forEach(checkbox => {
                        checkbox.checked = sessionData.tbmData.ppe.includes(checkbox.value);
                    });
                }
                document.getElementById('otherPpe').value = sessionData.tbmData.otherPpe || '';
            }
            
            // ë¦¬ë” ì´ë¦„ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateLeaderDisplay();
            
            // ë¦¬ë” ì„œëª… í‘œì‹œ
            const leaderCanvas = document.getElementById('leaderSignatureCanvas');
            if (leaderCanvas && sessionData.signatures && sessionData.signatures.leader) {
                const ctx = leaderCanvas.getContext('2d');
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, leaderCanvas.width, leaderCanvas.height);
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, leaderCanvas.width, leaderCanvas.height);
                    ctx.drawImage(img, 0, 0, leaderCanvas.width, leaderCanvas.height);
                };
                img.src = sessionData.signatures.leader;
            }
            
            // ìŒì„± íšŒì˜ë¡ ì—…ë°ì´íŠ¸
            if (sessionData.voiceTranscripts && sessionData.voiceTranscripts.length > 0) {
                const transcriptBox = document.getElementById('transcriptBox');
                transcriptBox.innerHTML = '';
                sessionData.voiceTranscripts.forEach(item => {
                    addTranscriptToUI(item);
                });
            }
        }
        
        // WorkTalk ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateWorktalkCount() {
            const countElement = document.getElementById('worktalkCount');
            if (countElement) {
                countElement.textContent = sessionData.worktalkData ? sessionData.worktalkData.length : 0;
            }
        }
        
        // ë¦¬ë” ì´ë¦„ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLeaderDisplay() {
            const leaderNameSpan = document.getElementById('currentLeaderName');
            if (leaderNameSpan && sessionData.tbmData && sessionData.tbmData.leader) {
                leaderNameSpan.textContent = sessionData.tbmData.leader;
                leaderNameSpan.style.color = '#ff6600';
            } else if (leaderNameSpan) {
                leaderNameSpan.textContent = 'ë¯¸ì§€ì •';
                leaderNameSpan.style.color = '#999';
            }
        }
        
        // ì°¸ì„ì ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateAttendeesList() {
            const tbody = document.getElementById('attendeesList');
            tbody.innerHTML = '';
            
            sessionData.users.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td><span class="user-avatar" style="width: 20px; height: 20px; font-size: 10px;">${user.name.substring(0, 2)}</span></td>
                    <td>
                        ${sessionData.signatures[user.id] ? 
                            '<span class="signature-status signed">ì„œëª…ì™„ë£Œ</span>' : 
                            `<button class="btn btn-primary" onclick="openSignatureModal('${user.id}')">ì„œëª…í•˜ê¸°</button>`
                        }
                    </td>
                `;
            });
        }
        
        // WorkTalk ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateWorktalkCards() {
            const container = document.getElementById('worktalkCards');
            container.innerHTML = '';
            
            if (!sessionData.worktalkData || sessionData.worktalkData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">ë“±ë¡ëœ ìœ„í—˜ì„±í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            sessionData.worktalkData.forEach((item, index) => {
                const riskScore = item.frequency * item.severity;
                let riskLevel = 'low';
                if (riskScore >= 12) riskLevel = 'high';
                else if (riskScore >= 6) riskLevel = 'medium';
                
                const card = document.createElement('div');
                card.className = 'worktalk-card';
                if (item.isVoiceGenerated) {
                    card.className += ' voice-generated';
                }
                
                card.innerHTML = `
                    ${item.isVoiceGenerated ? '<span class="voice-badge">ğŸ¤ ìŒì„±</span>' : ''}
                    <span class="card-author">${item.author}</span>
                    <div class="card-photo">
                        ${item.photo ? `<img src="${item.photo}" alt="í˜„ì¥ì‚¬ì§„">` : '<span>ì‚¬ì§„ ì—†ìŒ</span>'}
                    </div>
                    <h4>${item.location}</h4>
                    <p><strong>ì‘ì—…ë‚´ìš©:</strong> ${item.content}</p>
                    <p><strong>ìœ„í—˜ìš”ì¸:</strong> ${item.danger}</p>
                    <p><strong>ê°œì„ ëŒ€ì±…:</strong> ${item.improvement}</p>
                    <div style="margin-top: 10px;">
                        <span class="risk-badge ${riskLevel}">ìœ„í—˜ë„: ${riskScore}ì </span>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // ìœ„í—˜ìš”ì¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
        function updateRiskTable() {
            console.log('=== updateRiskTable ì‹œì‘ ===');
            const tbody = document.getElementById('riskTableBody');
            
            if (!tbody) {
                console.error('âŒ riskTableBodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // í…Œì´ë¸” ì´ˆê¸°í™”
            tbody.innerHTML = '';
            console.log('âœ… í…Œì´ë¸” ì´ˆê¸°í™” ì™„ë£Œ');
            
            // worktalkData í™•ì¸
            if (!sessionData.worktalkData || sessionData.worktalkData.length === 0) {
                console.log('âš ï¸ worktalkDataê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">ë“±ë¡ëœ ìœ„í—˜ì„±í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                updateDebugInfo();
                return;
            }
            
            console.log(`ğŸ“Š ìœ„í—˜ì„±í‰ê°€ ë°ì´í„° ê°œìˆ˜: ${sessionData.worktalkData.length}`);
            
            // ê° ìœ„í—˜ì„±í‰ê°€ í•­ëª©ì„ í…Œì´ë¸”ì— ì¶”ê°€
            sessionData.worktalkData.forEach((item, index) => {
                try {
                    console.log(`ğŸ”„ í–‰ ${index + 1} ì²˜ë¦¬ ì¤‘...`);
                    console.log('í•­ëª© ë°ì´í„°:', item);
                    
                    const row = tbody.insertRow();
                    
                    // ìœ„í—˜ë„ ê³„ì‚°
                    const frequency = parseInt(item.frequency) || 0;
                    const severity = parseInt(item.severity) || 0;
                    const riskScore = frequency * severity;
                    
                    let riskGrade = '';
                    let riskClass = '';
                    
                    if (riskScore >= 12) {
                        riskGrade = 'ìƒ';
                        riskClass = 'high';
                    } else if (riskScore >= 6) {
                        riskGrade = 'ì¤‘';
                        riskClass = 'medium';
                    } else {
                        riskGrade = 'í•˜';
                        riskClass = 'low';
                    }
                    
                    const frequencyText = ['', 'ë…„ 1-2íšŒ', 'ë¶„ê¸° 1íšŒ', 'ì›” 1-2íšŒ', 'ì£¼ 1-2íšŒ', 'ë§¤ì¼'][frequency] || '';
                    const severityText = ['', 'ì•„ì°¨ì‚¬ê³ ', 'ê²½ìƒ-í†µì›ì¹˜ë£Œ', 'ì¤‘ìƒ-ì…ì›í•„ìš”', 'ì‚¬ë§ ë˜ëŠ” ì¥ì• ì„± ì¤‘ìƒ'][severity] || '';
                    
                    // í…Œì´ë¸” í–‰ ë‚´ìš© ì„¤ì •
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.location || ''}</td>
                        <td>${item.content || ''}</td>
                        <td>${item.danger || ''}</td>
                        <td>${frequencyText}</td>
                        <td>${severityText}</td>
                        <td><span class="risk-badge ${riskClass}">${riskGrade} (${riskScore}ì )</span></td>
                        <td>${item.improvement || ''}</td>
                    `;
                    
                    console.log(`âœ… í–‰ ${index + 1} ì¶”ê°€ ì™„ë£Œ`);
                } catch (error) {
                    console.error(`âŒ í–‰ ${index + 1} ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:`, error);
                }
            });
            
            console.log('=== updateRiskTable ì™„ë£Œ ===');
            console.log('ìµœì¢… í…Œì´ë¸” í–‰ ìˆ˜:', tbody.rows.length);
            
            updateDebugInfo();
        }
        
        // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateDebugInfo() {
            if (!debugMode) return;
            
            const debugDiv = document.getElementById('debugInfo');
            const info = `
                <strong>ë””ë²„ê·¸ ì •ë³´:</strong><br>
                ì„¸ì…˜ì½”ë“œ: ${sessionData.sessionCode}<br>
                ë²„ì „: ${sessionData.version || 0}<br>
                ì‚¬ìš©ììˆ˜: ${sessionData.users.length}<br>
                ìœ„í—˜ì„±í‰ê°€ìˆ˜: ${sessionData.worktalkData ? sessionData.worktalkData.length : 0}<br>
                ìŒì„±íšŒì˜ë¡ìˆ˜: ${sessionData.voiceTranscripts ? sessionData.voiceTranscripts.length : 0}<br>
                í…Œì´ë¸” í–‰ìˆ˜: ${document.getElementById('riskTableBody').rows.length}<br>
                ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${sessionData.lastUpdated || 'N/A'}<br>
                ì—…ë°ì´íŠ¸í•œ ì‚¬ëŒ: ${sessionData.lastUpdatedBy || 'N/A'}<br>
                í˜„ì¬ ì‹œê°„: ${new Date().toLocaleTimeString()}
            `;
            debugDiv.innerHTML = info;
        }
        
        // ë””ë²„ê·¸ ì •ë³´ í† ê¸€
        function toggleDebugInfo() {
            debugMode = !debugMode;
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.classList.toggle('show');
            updateDebugInfo();
        }
        
        // íƒ­ ì „í™˜ (ìˆ˜ì •ëœ ë²„ì „)
        function switchTab(tabName, event) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ì„ íƒí•œ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // TBM íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ìœ„í—˜ìš”ì¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            if (tabName === 'tbm') {
                console.log('TBM íƒ­ìœ¼ë¡œ ì „í™˜ - ìœ„í—˜ìš”ì¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸');
                setTimeout(() => {
                    updateRiskTable();
                }, 100);
            }
            
            // WorkTalk íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            if (tabName === 'worktalk') {
                updateWorktalkCount();
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeEventListeners() {
            // WorkTalk í¼ ì œì¶œ
            const worktalkForm = document.getElementById('worktalkForm');
            if (worktalkForm) {
                worktalkForm.addEventListener('submit', handleWorktalkSubmit);
            }
            
            // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
            const wtPhoto = document.getElementById('wtPhoto');
            if (wtPhoto) {
                wtPhoto.addEventListener('change', handlePhotoPreview);
            }
            
            // TBM ë°ì´í„° ìë™ ì €ì¥
            ['tbmDate', 'tbmTime', 'tbmLocation', 'department', 'tbmLeader', 'workLocation', 'workContent', 'preparation', 'precautions', 'otherPpe'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        if (!sessionData.tbmData) sessionData.tbmData = {};
                        const key = id.replace('tbm', '').charAt(0).toLowerCase() + id.replace('tbm', '').slice(1);
                        sessionData.tbmData[key] = this.value;
                        
                        // ë¦¬ë”ê°€ ë³€ê²½ë˜ë©´ ë¦¬ë” ì´ë¦„ ì—…ë°ì´íŠ¸
                        if (id === 'tbmLeader') {
                            updateLeaderDisplay();
                        }
                        
                        saveSession();
                    });
                }
            });
            
            // ë³´í˜¸êµ¬ ì²´í¬ë°•ìŠ¤ ìë™ ì €ì¥
            document.querySelectorAll('input[name="ppe"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (!sessionData.tbmData) sessionData.tbmData = {};
                    if (!sessionData.tbmData.ppe) sessionData.tbmData.ppe = [];
                    
                    const checkedPpe = [];
                    document.querySelectorAll('input[name="ppe"]:checked').forEach(cb => {
                        checkedPpe.push(cb.value);
                    });
                    sessionData.tbmData.ppe = checkedPpe;
                    saveSession();
                });
            });
            
            // ì´ˆê¸° ë‚ ì§œ/ì‹œê°„ ì„¤ì •
            const now = new Date();
            document.getElementById('tbmDate').value = sessionData.tbmData.date || now.toISOString().split('T')[0];
            document.getElementById('tbmTime').value = sessionData.tbmData.time || now.toTimeString().split(' ')[0].substring(0, 5);
            
            // ë¦¬ë” ì„œëª… ìº”ë²„ìŠ¤ ì„¤ì •
            const leaderCanvas = document.getElementById('leaderSignatureCanvas');
            if (leaderCanvas) {
                leaderCanvas.width = leaderCanvas.offsetWidth;
                leaderCanvas.height = leaderCanvas.offsetHeight;
                
                // ë°°ê²½ìƒ‰ ì„¤ì •
                const ctx = leaderCanvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, leaderCanvas.width, leaderCanvas.height);
                
                // ë¦¬ë” ì„œëª…ì´ ìˆìœ¼ë©´ í‘œì‹œ
                if (sessionData.signatures && sessionData.signatures.leader) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0, leaderCanvas.width, leaderCanvas.height);
                    };
                    img.src = sessionData.signatures.leader;
                }
            }
        }
        
        // WorkTalk í¼ ì œì¶œ í•¸ë“¤ëŸ¬ (ìˆ˜ì •ëœ ë²„ì „)
        function handleWorktalkSubmit(e) {
            e.preventDefault();
            console.log('WorkTalk í¼ ì œì¶œ ì‹œì‘');
            
            // í¼ ë°ì´í„° ìˆ˜ì§‘
            const location = document.getElementById('wtLocation').value;
            const content = document.getElementById('wtContent').value;
            const danger = document.getElementById('wtDanger').value;
            const frequency = document.getElementById('wtFrequency').value;
            const severity = document.getElementById('wtSeverity').value;
            const improvement = document.getElementById('wtImprovement').value;
            
            // í•„ìˆ˜ í•„ë“œ í™•ì¸
            if (!location || !content || !danger || !frequency || !severity || !improvement) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const worktalkItem = {
                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                author: currentUser.name,
                location: location,
                content: content,
                danger: danger,
                frequency: parseInt(frequency),
                severity: parseInt(severity),
                improvement: improvement,
                photo: null,
                isVoiceGenerated: false,
                createdAt: new Date().toISOString()
            };
            
            console.log('ìƒì„±ëœ WorkTalk í•­ëª©:', worktalkItem);
            
            // ì‚¬ì§„ ì²˜ë¦¬
            const photoInput = document.getElementById('wtPhoto');
            if (photoInput.files && photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    worktalkItem.photo = e.target.result;
                    
                    // ë°ì´í„° ì¶”ê°€
                    if (!sessionData.worktalkData) {
                        sessionData.worktalkData = [];
                    }
                    
                    sessionData.worktalkData.push(worktalkItem);
                    console.log('WorkTalk ë°ì´í„° ì¶”ê°€ë¨ (ì‚¬ì§„ í¬í•¨):', sessionData.worktalkData.length + 'ê±´');
                    
                    // ì €ì¥ ë° ì—…ë°ì´íŠ¸
                    saveSession();
                    
                    // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
                    updateWorktalkCards();
                    updateRiskTable();
                    
                    // ì§€ì—° ì‹¤í–‰ìœ¼ë¡œ í•œ ë²ˆ ë” ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        updateRiskTable();
                        showUpdateIndicator('ìœ„í—˜ì„±í‰ê°€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (ì´ ' + sessionData.worktalkData.length + 'ê±´)');
                    }, 100);
                    
                    // í¼ ì´ˆê¸°í™”
                    document.getElementById('worktalkForm').reset();
                    document.getElementById('photoPreview').innerHTML = '<span>ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</span>';
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                // ì‚¬ì§„ ì—†ì´ ë°ì´í„° ì¶”ê°€
                if (!sessionData.worktalkData) {
                    sessionData.worktalkData = [];
                }
                
                sessionData.worktalkData.push(worktalkItem);
                console.log('WorkTalk ë°ì´í„° ì¶”ê°€ë¨ (ì‚¬ì§„ ì—†ìŒ):', sessionData.worktalkData.length + 'ê±´');
                
                // ì €ì¥ ë° ì—…ë°ì´íŠ¸
                saveSession();
                
                // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
                updateWorktalkCards();
                updateRiskTable();
                
                // ì§€ì—° ì‹¤í–‰ìœ¼ë¡œ í•œ ë²ˆ ë” ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    updateRiskTable();
                    showUpdateIndicator('ìœ„í—˜ì„±í‰ê°€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (ì´ ' + sessionData.worktalkData.length + 'ê±´)');
                }, 100);
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('worktalkForm').reset();
                document.getElementById('photoPreview').innerHTML = '<span>ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</span>';
            }
        }
        
        // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° í•¸ë“¤ëŸ¬
        function handlePhotoPreview(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').innerHTML = `<img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // ì„œëª… ëª¨ë‹¬
        let signatureUserId = null;
        let signatureCanvas = null;
        let signatureCtx = null;
        let isDrawing = false;
        
        function openSignatureModal(userId) {
            if (userId !== currentUser.id && userId !== 'leader') {
                alert('ë³¸ì¸ì˜ ì„œëª…ë§Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            signatureUserId = userId;
            document.getElementById('signatureModal').style.display = 'flex';
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');
            signatureCanvas.width = signatureCanvas.offsetWidth;
            signatureCanvas.height = signatureCanvas.offsetHeight;
            
            // ë°°ê²½ìƒ‰ ì„¤ì •
            signatureCtx.fillStyle = 'white';
            signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            
            // ì„  ìŠ¤íƒ€ì¼ ì„¤ì •
            signatureCtx.lineWidth = 2;
            signatureCtx.strokeStyle = '#000';
            signatureCtx.lineCap = 'round';
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            signatureCanvas.removeEventListener('mousedown', startDrawing);
            signatureCanvas.removeEventListener('touchstart', startDrawing);
            signatureCanvas.removeEventListener('mousemove', draw);
            signatureCanvas.removeEventListener('touchmove', draw);
            signatureCanvas.removeEventListener('mouseup', stopDrawing);
            signatureCanvas.removeEventListener('touchend', stopDrawing);
            signatureCanvas.removeEventListener('mouseout', stopDrawing);
            
            // í„°ì¹˜/ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì„¤ì •
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('touchstart', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('touchmove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('touchend', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);
        }
        
        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            signatureCtx.beginPath();
            signatureCtx.moveTo(x, y);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const rect = signatureCanvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function saveSignature() {
            const dataURL = signatureCanvas.toDataURL();
            sessionData.signatures[signatureUserId] = dataURL;
            saveSession();
            updateUI();
            closeSignatureModal();
            showUpdateIndicator('ì„œëª…ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            
            // ë¦¬ë” ì„œëª…ì¸ ê²½ìš° ìº”ë²„ìŠ¤ì—ë„ í‘œì‹œ
            if (signatureUserId === 'leader') {
                const leaderCanvas = document.getElementById('leaderSignatureCanvas');
                const img = new Image();
                img.onload = function() {
                    const ctx = leaderCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, leaderCanvas.width, leaderCanvas.height);
                };
                img.src = dataURL;
            }
        }
        
        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            signatureCtx.fillStyle = 'white';
            signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }
        
        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
        }
        
        // ì—…ë°ì´íŠ¸ í‘œì‹œ
        function showUpdateIndicator(message) {
            const indicator = document.getElementById('updateIndicator');
            document.getElementById('updateMessage').textContent = message;
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }
        
        // ìë™ ë™ê¸°í™”
        function startAutoSync() {
            console.log('ìë™ ë™ê¸°í™” ì‹œì‘');
            
            // ì´ˆê¸° ìœ„í—˜ìš”ì¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            setTimeout(() => {
                console.log('ì´ˆê¸° í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì‹œë„');
                updateRiskTable();
            }, 500);
            
            // ì •ê¸°ì ì¸ ë™ê¸°í™”
            setInterval(() => {
                const sessions = getSavedSessions();
                if (sessions[sessionData.sessionCode]) {
                    const serverData = sessions[sessionData.sessionCode];
                    
                    // ìƒˆë¡œìš´ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                    const hasNewData = JSON.stringify(serverData) !== JSON.stringify(sessionData);
                    
                    if (hasNewData) {
                        console.log('ìƒˆë¡œìš´ ë°ì´í„° ê°ì§€ë¨');
                        sessionData = serverData;
                        updateUI();
                        showUpdateIndicator('ë°ì´í„°ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                    }
                }
            }, 3000); // 3ì´ˆë§ˆë‹¤ ë™ê¸°í™”
        }
        
        // Excel ë‚´ë³´ë‚´ê¸° (ìŒì„± íšŒì˜ë¡ ì¶”ê°€)
        async function exportToExcel() {
            // ë‚ ì§œ í¬ë§·
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const timeStr = today.toTimeString().split(' ')[0];
            
            // CSV ì´ˆê¸°í™”
            let csv = '';
            
            // í—¤ë” í–‰ ìƒì„±
            let headers = [];
            headers.push('ì„¸ì…˜ì½”ë“œ', 'TBMì‹¤ì‹œì¼', 'ì‹¤ì‹œì‹œê°„', 'ì‹¤ì‹œì¥ì†Œ', 'ë¶€ì„œíŒ€', 'TBMë¦¬ë”', 'ì‘ì—…ì¥ì†Œ', 'ì‘ì—…ë‚´ìš©', 'ì‘ì—…ì „ì¤€ë¹„ì‚¬í•­', 'ì‘ì—…ì¤‘ì£¼ì˜ì‚¬í•­');
            
            // ë³´í˜¸êµ¬ í•„ë“œë“¤
            headers.push('ì•ˆì „ëª¨', 'ì•ˆì „í™”', 'ì•ˆì „ì¥ê°‘', 'ë³´ì•ˆê²½', 'ë°©ì§„ë§ˆìŠ¤í¬', 'ê·€ë§ˆê°œ', 'ì•ˆì „ëŒ€', 'ê¸°íƒ€ë³´í˜¸êµ¬');
            
            // ì°¸ì„ì í•„ë“œë“¤ (ìµœëŒ€ 20ëª…ê¹Œì§€)
            for (let i = 1; i <= 20; i++) {
                headers.push(`ì°¸ì„ì${i}ì´ë¦„`, `ì°¸ì„ì${i}ì„œëª…`);
            }
            
            // ìœ„í—˜ì„±í‰ê°€ í•„ë“œë“¤
            headers.push('ìœ„í—˜ì‘ì„±ì', 'ìœ„í—˜ì‘ì—…ì¥ì†Œ', 'ìœ„í—˜ì‘ì—…ë‚´ìš©', 'ìœ„í—˜ìš”ì¸', 'ì‘ì—…ë¹ˆë„', 'ìœ„í—˜ì¤‘ëŒ€ì„±', 'ìœ„í—˜ë„ì ìˆ˜', 'ìœ„í—˜ë“±ê¸‰', 'ê°œì„ ëŒ€ì±…', 'ìŒì„±ì…ë ¥ì—¬ë¶€');
            
            // ìŒì„± íšŒì˜ë¡ í•„ë“œ
            headers.push('íšŒì˜ë¡ì‹œê°„', 'íšŒì˜ë¡ë°œì–¸ì', 'íšŒì˜ë¡ë‚´ìš©', 'íšŒì˜ë¡í‚¤ì›Œë“œ');
            
            // ìš”ì•½ ì •ë³´
            headers.push('ì´ì°¸ì„ììˆ˜', 'ì„œëª…ì™„ë£Œìˆ˜', 'ìœ„í—˜ì„±í‰ê°€ê±´ìˆ˜', 'ìŒì„±íšŒì˜ë¡ê±´ìˆ˜', 'ê³ ìœ„í—˜ê±´ìˆ˜', 'ì¤‘ìœ„í—˜ê±´ìˆ˜', 'ì €ìœ„í—˜ê±´ìˆ˜');
            headers.push('ë°ì´í„°ìƒì„±ì¼ì‹œ');
            
            csv += headers.join(',') + '\n';
            
            // ê°€ì¥ ë§ì€ í–‰ ìˆ˜ ê²°ì • (ìœ„í—˜ì„±í‰ê°€ì™€ ìŒì„±íšŒì˜ë¡ ì¤‘ ë” ë§ì€ ê²ƒ)
            const riskCount = sessionData.worktalkData.length;
            const transcriptCount = sessionData.voiceTranscripts ? sessionData.voiceTranscripts.length : 0;
            const rowCount = Math.max(1, riskCount, transcriptCount);
            
            for (let rowIndex = 0; rowIndex < rowCount; rowIndex++) {
                let dataRow = [];
                
                // ê¸°ë³¸ ì •ë³´ (ëª¨ë“  í–‰ì— ë™ì¼í•˜ê²Œ ë°˜ë³µ)
                dataRow.push(sessionData.sessionCode);
                dataRow.push(sessionData.tbmData.date || '');
                dataRow.push(sessionData.tbmData.time || '');
                dataRow.push(`"${sessionData.tbmData.location || ''}"`);
                dataRow.push(`"${sessionData.tbmData.department || ''}"`);
                dataRow.push(`"${sessionData.tbmData.leader || ''}"`);
                dataRow.push(`"${sessionData.tbmData.workLocation || ''}"`);
                dataRow.push(`"${(sessionData.tbmData.workContent || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`);
                dataRow.push(`"${(sessionData.tbmData.preparation || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`);
                dataRow.push(`"${(sessionData.tbmData.precautions || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`);
                
                // ë³´í˜¸êµ¬ ì •ë³´ (ëª¨ë“  í–‰ì— ë™ì¼í•˜ê²Œ ë°˜ë³µ)
                const ppeItems = ['ì•ˆì „ëª¨', 'ì•ˆì „í™”', 'ì•ˆì „ì¥ê°‘', 'ë³´ì•ˆê²½', 'ë°©ì§„ë§ˆìŠ¤í¬', 'ê·€ë§ˆê°œ', 'ì•ˆì „ëŒ€'];
                ppeItems.forEach(item => {
                    dataRow.push((sessionData.tbmData.ppe || []).includes(item) ? 'O' : 'X');
                });
                dataRow.push(`"${sessionData.tbmData.otherPpe || ''}"`);
                
                // ì°¸ì„ì ì •ë³´ (ëª¨ë“  í–‰ì— ë™ì¼í•˜ê²Œ ë°˜ë³µ, ìµœëŒ€ 20ëª…)
                for (let i = 0; i < 20; i++) {
                    if (i < sessionData.users.length) {
                        const user = sessionData.users[i];
                        dataRow.push(user.name);
                        dataRow.push(sessionData.signatures[user.id] ? 'O' : 'X');
                    } else {
                        dataRow.push('', '');
                    }
                }
                
                // ìœ„í—˜ì„±í‰ê°€ ì •ë³´ (ê° í–‰ë§ˆë‹¤ ë‹¤ë¥¸ ìœ„í—˜ì„±í‰ê°€)
                if (rowIndex < sessionData.worktalkData.length) {
                    const item = sessionData.worktalkData[rowIndex];
                    const riskScore = item.frequency * item.severity;
                    let riskGrade = 'í•˜';
                    if (riskScore >= 12) riskGrade = 'ìƒ';
                    else if (riskScore >= 6) riskGrade = 'ì¤‘';
                    
                    const frequencyText = ['', 'ë…„1-2íšŒ', 'ë¶„ê¸°1íšŒ', 'ì›”1-2íšŒ', 'ì£¼1-2íšŒ', 'ë§¤ì¼'][item.frequency] || '';
                    const severityText = ['', 'ì•„ì°¨ì‚¬ê³ ', 'ê²½ìƒ', 'ì¤‘ìƒ', 'ì‚¬ë§'][item.severity] || '';
                    
                    dataRow.push(item.author);
                    dataRow.push(`"${item.location}"`);
                    dataRow.push(`"${item.content.replace(/"/g, '""').replace(/\n/g, ' ')}"`);
                    dataRow.push(`"${item.danger.replace(/"/g, '""').replace(/\n/g, ' ')}"`);
                    dataRow.push(frequencyText);
                    dataRow.push(severityText);
                    dataRow.push(riskScore);
                    dataRow.push(riskGrade);
                    dataRow.push(`"${item.improvement.replace(/"/g, '""').replace(/\n/g, ' ')}"`);
                    dataRow.push(item.isVoiceGenerated ? 'O' : 'X');
                } else {
                    // ìœ„í—˜ì„±í‰ê°€ê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ í•„ë“œ
                    dataRow.push('', '', '', '', '', '', '', '', '', '');
                }
                
                // ìŒì„± íšŒì˜ë¡ ì •ë³´
                if (sessionData.voiceTranscripts && rowIndex < sessionData.voiceTranscripts.length) {
                    const transcript = sessionData.voiceTranscripts[rowIndex];
                    dataRow.push(transcript.time);
                    dataRow.push(transcript.speaker);
                    dataRow.push(`"${transcript.text.replace(/"/g, '""')}"`);
                    dataRow.push(`"${transcript.keywords.join(', ')}"`);
                } else {
                    dataRow.push('', '', '', '');
                }
                
                // ìš”ì•½ ì •ë³´ (ì²« ë²ˆì§¸ í–‰ì—ë§Œ í‘œì‹œ, ë‚˜ë¨¸ì§€ëŠ” ë¹ˆ ê°’)
                if (rowIndex === 0) {
                    dataRow.push(sessionData.users.length);
                    dataRow.push(sessionData.users.filter(u => sessionData.signatures[u.id]).length);
                    dataRow.push(sessionData.worktalkData.length);
                    dataRow.push(sessionData.voiceTranscripts ? sessionData.voiceTranscripts.length : 0);
                    
                    const highRisk = sessionData.worktalkData.filter(item => (item.frequency * item.severity) >= 12).length;
                    const mediumRisk = sessionData.worktalkData.filter(item => {
                        const score = item.frequency * item.severity;
                        return score >= 6 && score < 12;
                    }).length;
                    const lowRisk = sessionData.worktalkData.filter(item => (item.frequency * item.severity) < 6).length;
                    
                    dataRow.push(highRisk);
                    dataRow.push(mediumRisk);
                    dataRow.push(lowRisk);
                    dataRow.push(`"${today.toLocaleString('ko-KR')}"`);
                } else {
                    dataRow.push('', '', '', '', '', '', '', '');
                }
                
                csv += dataRow.join(',') + '\n';
            }
            
            // BOM ì¶”ê°€í•˜ì—¬ í•œê¸€ ê¹¨ì§ ë°©ì§€
            const BOM = '\uFEFF';
            const csvContent = BOM + csv;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // íŒŒì¼ëª…
            const fileName = `TBM_${sessionData.sessionCode}_${dateStr}.csv`;
            
            // 1. ë¡œì»¬ì— ë‹¤ìš´ë¡œë“œ
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            
            // 2. ë¡œì»¬ ì„œë²„ë¡œ ì „ì†¡ (ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°)
            try {
                // FormData ìƒì„±
                const formData = new FormData();
                formData.append('file', blob, fileName);
                formData.append('sessionCode', sessionData.sessionCode);
                formData.append('date', dateStr);
                formData.append('time', timeStr);
                formData.append('department', sessionData.tbmData.department || '');
                formData.append('leader', sessionData.tbmData.leader || '');
                formData.append('userCount', sessionData.users.length.toString());
                formData.append('riskCount', sessionData.worktalkData.length.toString());
                formData.append('transcriptCount', (sessionData.voiceTranscripts ? sessionData.voiceTranscripts.length : 0).toString());
                
                // ë¡œì»¬ ì„œë²„ URL
                const SERVER_URL = 'http://localhost:3000/api/tbm/upload';
                
                // ì„œë²„ë¡œ ì „ì†¡
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showUpdateIndicator('Excel íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ê³  ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    console.log('ì„œë²„ ì €ì¥ ì„±ê³µ:', result);
                } else {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
            } catch (error) {
                // ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì˜¤ë¥˜ê°€ ìˆëŠ” ê²½ìš°
                console.log('ì„œë²„ ì €ì¥ ì‹œë„ ì‹¤íŒ¨ (ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ ìˆ˜ ìˆìŒ):', error);
                showUpdateIndicator('Excel íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        }
        
        // ì¸ì‡„
        function printDocument() {
            // ì¸ì‡„ ì‹œ TBM íƒ­ë§Œ í‘œì‹œë˜ë„ë¡ ì„¤ì •
            window.print();
            
            // ì¸ì‡„ ì™„ë£Œ ì•Œë¦¼
            setTimeout(() => {
                showUpdateIndicator('PDF ì¸ì‡„/ì €ì¥ ëŒ€í™”ìƒìê°€ ì—´ë ¸ìŠµë‹ˆë‹¤');
            }, 100);
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ìŒì„± ì¸ì‹ ì¤‘ì§€
                if (recognition && (isMeetingRecording || isVoiceMemoRecording)) {
                    recognition.stop();
                }
                location.reload();
            }
        }
        
        // ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function testMicrophone() {
            console.log('ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            try {
                // 1. ê¶Œí•œ ìƒíƒœ í™•ì¸
                if (navigator.permissions && navigator.permissions.query) {
                    try {
                        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                        console.log('ê¶Œí•œ ìƒíƒœ:', permissionStatus.state);
                        alert(`í˜„ì¬ ë§ˆì´í¬ ê¶Œí•œ ìƒíƒœ: ${permissionStatus.state}\n\n` +
                              `- prompt: ê¶Œí•œ ìš”ì²­ ê°€ëŠ¥\n` +
                              `- granted: í—ˆìš©ë¨\n` +
                              `- denied: ì°¨ë‹¨ë¨`);
                    } catch (e) {
                        console.log('ê¶Œí•œ í™•ì¸ ë¶ˆê°€:', e);
                    }
                }
                
                // 2. ë§ˆì´í¬ ì ‘ê·¼ ì‹œë„
                alert('ì´ì œ ë§ˆì´í¬ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤.\níŒì—…ì´ ë‚˜íƒ€ë‚˜ë©´ "í—ˆìš©"ì„ ì„ íƒí•˜ì„¸ìš”.');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                
                // ì„±ê³µ!
                alert('âœ… ë§ˆì´í¬ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ì œ ìŒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                
                // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                console.error('ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                
                let solution = 'âŒ ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨\n\n';
                
                if (error.name === 'NotAllowedError') {
                    solution += 'ğŸ“± ëª¨ë°”ì¼ í•´ê²° ë°©ë²•:\n\n';
                    solution += 'ë°©ë²• 1 (ê°€ì¥ ì‰¬ì›€):\n';
                    solution += '1. Chrome ì‹œí¬ë¦¿ ëª¨ë“œë¡œ ì´ í˜ì´ì§€ ì—´ê¸°\n';
                    solution += '2. ë‹¤ì‹œ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸\n\n';
                    solution += 'ë°©ë²• 2:\n';
                    solution += '1. í•¸ë“œí° ì„¤ì • ì•±\n';
                    solution += '2. ì•± (ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜)\n';
                    solution += '3. Chrome ì°¾ê¸°\n';
                    solution += '4. ê¶Œí•œ\n';
                    solution += '5. ë§ˆì´í¬ ì¼œê¸°';
                } else if (error.name === 'NotFoundError') {
                    solution += 'ë§ˆì´í¬ê°€ ì—†ê±°ë‚˜ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n';
                    solution += 'ì´ì–´í°ì„ ì—°ê²°í•´ë³´ì„¸ìš”.';
                } else {
                    solution += `ì˜¤ë¥˜: ${error.name}\n${error.message}`;
                }
                
                alert(solution);
            }
        }
        
        // ë¦¬ë” ì„œëª… ê´€ë ¨ í•¨ìˆ˜ ì¶”ê°€
        function openLeaderSignatureModal() {
            const leader = sessionData.tbmData.leader;
            
            if (!leader) {
                alert('ë¨¼ì € TBM ë¦¬ë”ë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (leader !== currentUser.name) {
                alert(`TBM ë¦¬ë”(${leader})ë§Œ ì„œëª…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ì‚¬ìš©ì: ${currentUser.name}`);
                return;
            }
            
            console.log('ë¦¬ë” ì„œëª… ëª¨ë‹¬ ì—´ê¸° - ë¦¬ë”:', leader, 'í˜„ì¬ ì‚¬ìš©ì:', currentUser.name);
            openSignatureModal('leader');
        }
        
        function clearLeaderSignature() {
            const leader = sessionData.tbmData.leader;
            
            if (!leader || leader !== currentUser.name) {
                alert('TBM ë¦¬ë”ë§Œ ì„œëª…ì„ ì§€ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            const canvas = document.getElementById('leaderSignatureCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (sessionData.signatures) {
                delete sessionData.signatures.leader;
                saveSession();
                updateUI();
                showUpdateIndicator('ë¦¬ë” ì„œëª…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        }
    </script>
</body>
</html>
